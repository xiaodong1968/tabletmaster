<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name=renderer  content=webkit>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <link th:href="@{/third/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/third/font-awesome-4.7.0/css/font-awesome.css}" rel="stylesheet">
    <link th:href="@{/third/css/animate.css}" rel="stylesheet">
    <link th:href="@{/third/DataTables/datatables.min.css}" rel="stylesheet">
    <link th:href="@{/third/lib/layui/css/layui.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/third/jtree/css/style.min.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/custom.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/awesome-bootstrap-checkbox.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/css/bootstrap_modify.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/css/seeTaskDialog.css}" rel="stylesheet" type="text/css"></link>
    <title>任务表单</title>
    <style>
        .searchUser{
            display: inline-block;
            background: #4c8b4c;
            height: 25px;
            line-height: 25px;
            width: 80px;
            text-align: center;
            color: white;
            margin-left: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .inputItemValue{
            cursor:pointer;
            color: red;
        }
    </style>
</head>
<body>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row" style="margin: 0px">
        <div class="col-sm-12" style="margin: 0px;padding:0px;">
            <div class="ibox float-e-margins">
                <div class="task_show">
                    <div class="taskInfo">
                            <input th:value="${seeModel}" id="seeModel"  type="hidden">
                            <input th:value="${task.id}" id="taskId"  type="hidden">
                            <input th:value="${task.statu}" id="taskStatu"  type="hidden">
                            <div class="taskDetail">
                                <div class="taskDetail_label"><label>【任务名称】：</label><label th:text="${task.name}"></label></div>
                                <div class="taskDetail_label"><label>【任务开始时间】：</label><label th:text="${task.startTimeStr}"></label></div>
                                <div class="taskDetail_label"><label>【任务结束时间】：</label><label th:text="${task.endTimeStr}"></label></div>
                                <div class="taskDetail_label"><label>【任务状态】：</label>
                                     <label th:if="${task.statu}==0" style="color:#f94f29">未开始</label>
                                     <label th:if="${task.statu}==1" style="color:#f94f29">已结束</label>
                                     <label th:if="${task.statu}==2" style="color:#f94f29">进行中</label>
                                </div>
                                <div class="taskDetail_label">
                                    <label>【任务发布者】：</label><label th:text="${task.owner.realname}"></label>
                                </div>
                            </div>
                            <div class="reciverInfo" style="height: 40px;line-height: 40px">
                                <label>【任务接收者】：</label>
                                <select style="color: black;width: 150px;" id="taskReciver" th:if="${seeModel}==0">
                                    <option selected th:if="${ownerId}==${reciver.id}" th:each="reciver:${task.reciver}" th:value="${reciver.id}" th:text="${reciver.realname}"></option>
                                    <option th:unless="${ownerId}==${reciver.id}" th:each="reciver:${task.reciver}" th:value="${reciver.id}" th:text="${reciver.realname}"></option>
                                </select>
                                <label th:if="${seeModel}==0">
                                    <input type="text" placeholder="请输入要查看的接收者名称" id="searchUser" style="width: 200px"><label class="searchUser" onclick="searchUser(this)">搜索</label>
                                </label>
                                <label th:text="${currentUser}" th:if="${seeModel}==1">
                                </label>
                                <input type="hidden" th:value="${currentUserId}" id="currentUserId" th:if="${seeModel}==1">
                            </div>
                            <div th:if="${seeModel}==0" style="height: 30px;">
                                <label class="tool_btn" onclick="showStatistics()">统计报表</label>
                                &nbsp;
                                <label class="tool_btn" onclick="refreshPage()">刷新页面</label>
                               <!-- <label class="tool_btn" onclick="testCreateJob()">创建任务</label>-->
                            </div>
                            <div th:if="${seeModel}==1" style="height: 30px;">
                                <label class="tool_btn" onclick="refreshPageModel1()">刷新页面</label>
                                <!-- <label class="tool_btn" onclick="testCreateJob()">创建任务</label>-->
                            </div>
                        </div>

                    </div>
                    <div class="form_show">
                        <table id="mytable">
                            <thead>
                                <tr >
                                    <td th:text="${task.name}" th:colspan="${myForm.cols}"></td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="row:${rows}">
                                        <td th:each="item:${myForm.itmes}" th:if="${item.row}==${row} and ${item.mergeModel}==0" th:rowspan="${item.mergeLength}">
                                            <object th:if="${item.type}==0">
                                                <label th:text="${item.name}"></label>
                                            </object>
                                            <object th:if="${item.type}==1">
                                                <label class="uploadlabel" th:if="${item.statu}==0" style="color: red;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==1" style="color: royalblue;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==2" style="color: #6298bf;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}"></label>
                                                </label>
                                            </object>
                                            <object th:if="${item.type}==2">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self"></label>
                                            </object>
                                            <object th:if="${item.type}==3">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au"></label>
                                            </object>
                                            <object th:if="${item.type}==4">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self_count"></label>
                                            </object>
                                            <object th:if="${item.type}==5">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au_count"></label>
                                            </object>
                                        </td>
                                        <td th:each="item:${myForm.itmes}" th:if="${item.row}==${row} and ${item.mergeModel}==1" th:colspan="${item.mergeLength}">
                                            <object th:if="${item.type}==0">
                                                <label th:text="${item.name}"></label>
                                            </object>
                                            <object th:if="${item.type}==1">
                                                <label class="uploadlabel" th:if="${item.statu}==0" style="color: red;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">未上传</label>
                                                <label class="uploadlabel" th:if="${item.statu}==1" style="color: royalblue;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">已上传</label>
                                                <label class="uploadlabel" th:if="${item.statu}==2" style="color: #6298bf;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">部分上传</label>
                                            </object>
                                            <object th:if="${item.type}==2">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self"></label>
                                            </object>
                                            <object th:if="${item.type}==3">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au"></label>
                                            </object>
                                            <object th:if="${item.type}==4">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self_count"></label>
                                            </object>
                                            <object th:if="${item.type}==5">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au_count"></label>
                                            </object>
                                        </td>
                                        <td th:each="item:${myForm.itmes}" th:if="${item.row}==${row} and ${item.mergeModel}==-1">
                                            <object th:if="${item.type}==0">
                                                <label th:text="${item.name}"></label>
                                            </object>
                                            <object th:if="${item.type}==1">
                                                <label class="uploadlabel" th:if="${item.statu}==0" style="color: red;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==1" style="color: royalblue;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==2" style="color: #6298bf;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}"></label>
                                                </label>
                                            </object>
                                            <object th:if="${item.type}==2">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self"></label>
                                            </object>
                                            <object th:if="${item.type}==3">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au"></label>
                                            </object>
                                            <object th:if="${item.type}==4">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self_count"></label>
                                            </object>
                                            <object th:if="${item.type}==5">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au_count"></label>
                                            </object>
                                         </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 公共尾部开始 -->
<!-- 公共尾部开始 -->
<script th:src="@{/third/js/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.metisMenu.js}" type="text/javascript"></script>
<script th:src="@{/third/js/hAdmin.js}" type="text/javascript"></script>
<script th:src="@{/third/lib/layui/layui.all.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.validate.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/message_zh.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/validate_default.js}" type="text/javascript"></script>
<script th:src="@{/third/DataTables/datatables.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.slimscroll.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/global.js}" type="text/javascript"></script>
<script th:src="@{/third/js/sock.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.cookie.js}" type="text/javascript"></script>
<script th:src="@{/third/js/stomp.js}" type="text/javascript"></script>
<script th:src="@{/third/jtree/js/jstree.min.js}" type="text/javascript"></script>
<!-- 公共尾部结束 -->
<script>
  var currentId=$("#taskReciver option:selected").val();
  var currentName=$("#taskReciver option:selected").text();
  $("#searchUser").val(currentName);
  $("#taskReciver").unbind("change").bind("change",function(){
        var taskId=$("#taskId").val();
        location.href="seeTaskDialog?seeModel=0&taskId="+taskId+"&ownerId="+$("#taskReciver").val();
  });
  //查看任务统计报表
  function showStatistics(){
      var taskId=$("#taskId").val();
      var showStatisticsDialog = layer.open({
          type : 2,
          title : "任务统计",
          content : "taskStatistics?taskId="+taskId,
          end : function() {

          }
      });
      layer.full(showStatisticsDialog);
  }
  function testCreateJob(){
      var taskId=$("#taskId").val();
      $.ajax({
          url:"testCreateJob",
          data:{"taskId":taskId},
          success:function(data){

          }
      })
  }
  //输入控件被点击
  $(".inputItemValue").unbind("click").bind("click",function () {
      var seeModel=$("#seeModel").val();
      var itemId=$(this).parent().find("input[type=hidden]").eq(0).val();
      var type=$(this).parent().find("input[type=hidden]").eq(1).val();
      var value_limit=$(this).parent().find("input[type=hidden]").eq(2).val();
      var $this=$(this);
      var taskStatu=$("#taskStatu").val();
      if(type==2&&taskStatu==1){
          layer.msg("任务已经结束！");
          return ;
      }
      if(type==2&&taskStatu==0){
          layer.msg("任务未开始！");
          return ;
      }
      if(type==3&&taskStatu==0){
          layer.msg("任务未开始！");
          return ;
      }
      if(seeModel==1&&type==3){
          layer.msg("不可以为自己评分哦！");
          return ;
      }
      layer.prompt({title: '请输入分值：', formType: 3}, function(value, index){
              if(!(/^[0-9]+$/.test(value))){
                  layer.msg("只能是数字!");
                  return ;
              }
              if( parseInt(value) > parseInt(value_limit)){
                  layer.msg("超出最大值!");
                  return ;
              }
              $.ajax({
                  url:"modifyItemValue",
                  type:'post',
                  data:{"itemId":itemId,"value":value},
                  success:function(data){
                    if(data==1){
                        $($this).html(value);
                        layer.close(index);
                    }else{
                        layer.msg("修改失败!");
                        layer.close(index);
                    }
                     if(seeModel==0){
                         refreshPage();
                     }
                     if(seeModel==1){
                        refreshPageModel1();
                     }
                  }
              });
          });
  });
  //上传控件被点击
  $(".uploadlabel").unbind("click").bind("click",function () {
        var itemId=$(this).find("input[type=hidden]").val();
        var taskStatu=$("#taskStatu").val();
        if(taskStatu==1||$("#seeModel").val()==0){
            var showStatisticsDialog = layer.open({
                type : 2,
                title : "查看文件",
                content : "seeTaskFileDialog?itemId="+itemId,
                end : function() {

                }
            });
            layer.full(showStatisticsDialog);
        }
        if($("#seeModel").val()==1&&taskStatu==2){
            var showStatisticsDialog = layer.open({
                type : 2,
                title : "上传文件",
                content : "uploadTaskFileDialog?itemId="+itemId,
                end : function() {

                }
            });
            layer.full(showStatisticsDialog);
        }
  });
  //搜索用户
  function searchUser($this){
          var searchUser=$("#searchUser").val();
         $.each($("#taskReciver option"),function(){
            if($(this).text()==searchUser){
               userId= $(this).val();
                var taskId=$("#taskId").val();
                location.href="seeTaskDialog?seeModel=0&taskId="+taskId+"&ownerId="+userId;
                return ;
            }
         });
        layer.msg("没有符合条件的结果！");
  }
   //只读模式下刷新页面
    function refreshPage(){
        var taskId=$("#taskId").val();
        location.href="seeTaskDialog?seeModel=0&taskId="+taskId+"&ownerId="+$("#taskReciver").val();
    }
  //编辑模式下刷新页面
    function refreshPageModel1(){
        var taskId=$("#taskId").val();
        location.href="seeTaskDialog?seeModel=1&taskId="+taskId+"&ownerId="+$("#currentUserId").val();
    }
</script>
</body>
</html>