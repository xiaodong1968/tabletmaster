<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name=renderer  content=webkit>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <link th:href="@{/third/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/third/font-awesome-4.7.0/css/font-awesome.css}" rel="stylesheet">
    <link th:href="@{/third/css/animate.css}" rel="stylesheet">
    <link th:href="@{/third/DataTables/datatables.min.css}" rel="stylesheet">
    <link th:href="@{/third/lib/layui/css/layui.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/third/jtree/css/style.min.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/custom.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/awesome-bootstrap-checkbox.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/css/bootstrap_modify.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/css/seeTaskDialog.css}" rel="stylesheet" type="text/css"></link>
    <title>任务表单</title>
    <style>
        .searchUser{
            display: inline-block;
            background:  #5a9d90;
            height: 25px;
            line-height: 25px;
            width: 80px;
            text-align: center;
            color: white;
            margin-left: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .inputItemValue{
            cursor: pointer;
            color: red;
            display: block;
            width: 100%;
            height: 100%;
            line-height: 50px;
        }
        #fhrecordWrap{
            position: absolute;
            left: 0px;
            top: 100px;
            width: 100%;
            height: auto;
            overflow: auto;
        }
        #fhrecordTable{
            background: rgb(76 72 72);
            color: white;
            width: 100%;
            height: 100%;
            text-align: center;
            margin: 0px auto;
            cursor: pointer;

        }
        #fhrecordTable tr{
            border-bottom: 1px dashed #767676;
        }
        #fhrecordTable tr td{
            padding: 10px;
            border-left: 1px dashed gray;
        }
        #mytable thead{
            background:rgb(239,243,248);
            color: #201f1f;
        }
        #mytable thead tr{
            border: 1px dashed #efeded;;
        }
        label{
            font-weight: normal;
        }
        body{
            overflow: auto;
        }
    </style>
</head>
<body>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row" style="margin: 0px">
        <div class="col-sm-12" style="margin: 0px;padding:0px;">
            <div class="ibox float-e-margins" style="margin-bottom: 0px;">
                <div class="task_show">
                    <div class="taskInfo">
                            <input th:value="${seeModel}" id="seeModel"  type="hidden">
                            <input th:value="${task.id}" id="taskId"  type="hidden">
                            <input th:value="${task.statu}" id="taskStatu"  type="hidden">
                            <div class="taskDetail">
                                <div class="taskDetail_label">
                                    <label><i class="fa fa-bullhorn"></i></label>
                                    <label th:text="${task.name}"></label>
                                    &nbsp;&nbsp;
                                    <label><i class="fa fa-user-circle-o"></i></label>
                                    <label th:text="${task.owner.realname}"></label>
                                    &nbsp;&nbsp;
                                    <label><i class="fa fa-hourglass-end"></i></label>
                                    <label th:if="${task.statu}==0" style="color:#f94f29">未开始</label>
                                    <label th:if="${task.statu}==1" style="color:#f94f29">已结束</label>
                                    <label th:if="${task.statu}==2" style="color:#f94f29">进行中</label>
                                </div>
                                <div class="taskDetail_label">
                                    <label><i class="fa fa-calendar-check-o"></i></label>
                                    <label th:text="${task.startTimeStr}"></label>
                                    &nbsp;&nbsp;
                                    <label><i class="fa fa-calendar-times-o"></i></label>
                                    <label th:text="${task.endTimeStr}"></label>
                                </div>
                            </div>
                            <div class="reciverInfo" style="height: 30px;line-height: 30px">
                                <label>
                                    <i class="fa fa-at"></i>
                                </label>
                                <select style="color: black;width: 180px;" id="userGroup" th:if="${seeModel}==0">
                                    <option selected th:if="${currentGroupId}==${group.id}" th:each="group:${groups}" th:value="${group.id}" th:text="${group.name}"></option>
                                    <option th:unless=="${currentGroupId}==${group.id}" th:each="group:${groups}" th:value="${group.id}" th:text="${group.name}"></option>
                                </select>
                                <select style="color: black;width: 150px;" id="taskReciver" th:if="${seeModel}==0">
                                    <option selected th:if="${ownerId}==${reciver.id}" th:each="reciver:${task.reciver}" th:value="${reciver.id}" th:text="${reciver.realname}"></option>
                                    <option th:unless="${ownerId}==${reciver.id}" th:each="reciver:${task.reciver}" th:value="${reciver.id}" th:text="${reciver.realname}"></option>
                                </select>
                                <label th:if="${seeModel}==0">
                                    <input type="text" placeholder="请输入要查看的接收者名称" id="searchUser" style="width: 200px"><label class="searchUser" onclick="searchUser(this)">搜索</label>
                                </label>
                                <label th:text="${currentUser}" th:if="${seeModel}==1">
                                </label>
                                <input type="hidden" th:value="${currentUserId}" id="currentUserId" th:if="${seeModel}==1">
                            </div>
                            <div th:if="${seeModel}==0" style="height: 30px;">
                                <label class="tool_btn" onclick="showStatistics()">统计报表</label>
                                &nbsp;
                                <label class="tool_btn" onclick="refreshPage()">刷新页面</label>

                               <!-- <label class="tool_btn" onclick="testCreateJob()">创建任务</label>-->
                            </div>
                            <div th:if="${seeModel}==1" style="height: 30px;">
                                <label class="tool_btn" onclick="refreshPageModel1()">刷新页面</label>


                                <!-- <label class="tool_btn" onclick="testCreateJob()">创建任务</label>-->
                            </div>
                        </div>

                    </div>
                    <div class="form_show">
                        <table id="mytable">
                            <thead>
                                <tr >
                                    <td th:text="${task.name}" th:colspan="${myForm.cols}"></td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="row:${rows}">
                                        <td th:each="item:${myForm.itmes}" th:if="${item.row}==${row} and ${item.mergeModel}==0" th:rowspan="${item.mergeLength}">
                                            <object th:if="${item.type}==0">
                                                <label th:text="${item.name}"></label>
                                            </object>
                                            <object th:if="${item.type}==1">
                                                <label class="uploadlabel" th:if="${item.statu}==0" style="color: red;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==1" style="color: royalblue;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==2" style="color: #6298bf;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                            </object>
                                            <object th:if="${item.type}==2">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self"></label>
                                            </object>
                                            <object th:if="${item.type}==3" style="position: relative">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au"></label>
                                            </object>
                                            <object th:if="${item.type}==4">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self_count"></label>
                                            </object>
                                            <object th:if="${item.type}==5">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au_count"></label>
                                            </object>
                                        </td>
                                        <td th:each="item:${myForm.itmes}" th:if="${item.row}==${row} and ${item.mergeModel}==1" th:colspan="${item.mergeLength}">
                                            <object th:if="${item.type}==0">
                                                <label th:text="${item.name}"></label>
                                            </object>
                                            <object th:if="${item.type}==1">
                                                <label class="uploadlabel" th:if="${item.statu}==0" style="color: red;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==1" style="color: royalblue;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==2" style="color: #6298bf;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                            </object>
                                            <object th:if="${item.type}==2">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self"></label>
                                            </object>
                                            <object th:if="${item.type}==3" style="position: relative">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au"></label>
                                            </object>
                                            <object th:if="${item.type}==4">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self_count"></label>
                                            </object>
                                            <object th:if="${item.type}==5">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au_count"></label>
                                            </object>
                                        </td>
                                        <td th:each="item:${myForm.itmes}" th:if="${item.row}==${row} and ${item.mergeModel}==-1">
                                            <object th:if="${item.type}==0">
                                                <label th:text="${item.name}"></label>
                                            </object>
                                            <object th:if="${item.type}==1">
                                                <label class="uploadlabel" th:if="${item.statu}==0" style="color: red;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==1" style="color: royalblue;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                                <label class="uploadlabel" th:if="${item.statu}==2" style="color: #6298bf;font-weight: bold">
                                                    <input type="hidden" th:value="${item.id}">
                                                    <label th:text="${item.totalFiles}" class="uoloadFiles"></label>
                                                </label>
                                            </object>
                                            <object th:if="${item.type}==2">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self"></label>
                                            </object>
                                            <object th:if="${item.type}==3"  style="position: relative">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au"></label>
                                            </object>
                                            <object th:if="${item.type}==4">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_self_count"></label>
                                            </object>
                                            <object th:if="${item.type}==5">
                                                <input type="hidden" th:value="${item.id}">
                                                <input type="hidden" th:value="${item.type}">
                                                <input type="hidden" th:value="${item.value_limit}">
                                                <label type="text" th:text="${item.itemValue}" class="inputItemValue inputItemValue_au_count"></label>
                                            </object>
                                         </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 公共尾部开始 -->
<!-- 公共尾部开始 -->
<script th:src="@{/third/js/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.metisMenu.js}" type="text/javascript"></script>
<script th:src="@{/third/js/hAdmin.js}" type="text/javascript"></script>
<script th:src="@{/third/lib/layui/layui.all.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.validate.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/message_zh.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/validate_default.js}" type="text/javascript"></script>
<script th:src="@{/third/DataTables/datatables.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.slimscroll.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/global.js}" type="text/javascript"></script>
<script th:src="@{/third/js/sock.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.cookie.js}" type="text/javascript"></script>
<script th:src="@{/third/js/stomp.js}" type="text/javascript"></script>
<script th:src="@{/third/jtree/js/jstree.min.js}" type="text/javascript"></script>
<!-- 公共尾部结束 -->
<script>
  var currentId=$("#taskReciver option:selected").val();
  var currentName=$("#taskReciver option:selected").text();
  $("#searchUser").val(currentName);
  $("#taskReciver").unbind("change").bind("change",function(){
        var taskId=$("#taskId").val();
        location.href="seeTaskDialog?seeModel=0&taskId="+taskId+"&ownerId="+$("#taskReciver").val()+"&groupId="+$("#userGroup").val();
  });
  $("#userGroup").unbind("change").bind("change",function(){
      var taskId=$("#taskId").val();
      $.ajax({
          url:'checkGroupMatchTask',
          data:{"groupId":$("#userGroup").val(),"taskId":taskId},
          success:function(data){
              if(data==1){
                  location.href="seeTaskDialog?seeModel=0&taskId="+taskId+"&groupId="+$("#userGroup").val();
              }else{
                  layer.msg('该组没有成员参与本次任务', {
                      icon: 0,
                      time: 2000 //2秒关闭（如果不配置，默认是3秒）
                  }, function(){
                      location.href="seeTaskDialog?seeModel=0&taskId="+taskId;
                  });


              }
          }
      })

  });
  //查看任务统计报表
  function showStatistics(){
      var taskId=$("#taskId").val();
      var showStatisticsDialog = layer.open({
          type : 2,
          title : "任务统计",
          content : "taskStatistics?taskId="+taskId,
          end : function() {

          }
      });
      layer.full(showStatisticsDialog);
  }
  function testCreateJob(){
      var taskId=$("#taskId").val();
      $.ajax({
          url:"testCreateJob",
          data:{"taskId":taskId},
          success:function(data){

          }
      })
  }
  //输入控件被点击
  $(".inputItemValue").unbind("click").bind("click",function () {
      var seeModel=$("#seeModel").val();
      var itemId=$(this).parent().find("input[type=hidden]").eq(0).val();
      var type=$(this).parent().find("input[type=hidden]").eq(1).val();
      if(type==4){
          layer.msg("自动统计，无需手动输入!");
          return ;
      }
      if(type==5){
          showFhRecord(itemId);
          return ;
      }
      var value_limit=$(this).parent().find("input[type=hidden]").eq(2).val();
      var $this=$(this);
      var taskStatu=$("#taskStatu").val();
      if(seeModel==0&&type==2){
          layer.msg("你不可以替他/她自评！");
          return ;
      }
      if(type==2&&taskStatu==1){
          layer.msg("任务已经结束！");
          return ;
      }
      if(type==2&&taskStatu==0){
          layer.msg("任务未开始！");
          return ;
      }
      if(type==3&&taskStatu==0){
          layer.msg("任务未开始！");
          return ;
      }
      if(seeModel==1&&type==3){
          layer.msg("不可以为自己评分哦！");
          return ;
      }
      if(type==3){
         layer.open({
              type : 2,
              title : "复核评分",
              area:["500px","300px"],
              content : 'modifyItemValueForFhDialog?itemId='+itemId,
              end : function() {
                  if(seeModel==0){
                      refreshPage();
                  }
                  if(seeModel==1){
                      refreshPageModel1();
                  }
              }
          });
          return ;
      }
      else{
          layer.prompt({title: '请输入分值：', formType: 3}, function(value, index){
              if(!(/^[0-9]+$|^[0-9]+[\.]{1,1}[1-9]{1,1}$/.test(value))){
                  layer.msg("只能是整数或小数（小数点后最多保留1位）!");
                  return ;
              }
              if( parseFloat(value) > parseFloat(value_limit)){
                  layer.msg("超出最大值!");
                  return ;
              }
              $.ajax({
                  url:"modifyItemValue",
                  type:'post',
                  data:{"itemId":itemId,"value":value},
                  success:function(data){
                      if(data==1){
                          $($this).html(value);
                          layer.close(index);
                      }else{
                          layer.msg("修改失败!");
                          layer.close(index);
                      }
                      if(seeModel==0){
                          refreshPage();
                      }
                      if(seeModel==1){
                          refreshPageModel1();
                      }
                  }
              });
          });
      }
  });
  //上传控件被点击
  $(".uploadlabel").unbind("click").bind("click",function () {
        var itemId=$(this).find("input[type=hidden]").val();
        var taskStatu=$("#taskStatu").val();
        if(taskStatu==1||$("#seeModel").val()==0){
            var showStatisticsDialog = layer.open({
                type : 2,
                title : "查看文件",
                content : "seeTaskFileDialog?itemId="+itemId,
                end : function() {

                }
            });
            layer.full(showStatisticsDialog);
        }
        if($("#seeModel").val()==1&&taskStatu==2){
            var showStatisticsDialog = layer.open({
                type : 2,
                title : "上传文件",
                content : "uploadTaskFileDialog?itemId="+itemId,
                end : function() {

                }
            });
            layer.full(showStatisticsDialog);
        }
  });
  //搜索用户
  function searchUser($this){
          var searchUser=$("#searchUser").val();
         $.each($("#taskReciver option"),function(){
            if($(this).text()==searchUser){
               userId= $(this).val();
                var taskId=$("#taskId").val();
                location.href="seeTaskDialog?seeModel=0&taskId="+taskId+"&ownerId="+userId+"&groupId="+$("#userGroup").val();
                return ;
            }
         });
        layer.msg("没有符合条件的结果！");
  }
   //只读模式下刷新页面
    function refreshPage(){
        var taskId=$("#taskId").val();
        location.href="seeTaskDialog?seeModel=0&taskId="+taskId+"&ownerId="+$("#taskReciver").val()+"&groupId="+$("#userGroup").val();
    }
  //编辑模式下刷新页面
    function refreshPageModel1(){
        var taskId=$("#taskId").val();
        location.href="seeTaskDialog?seeModel=1&taskId="+taskId+"&ownerId="+$("#currentUserId").val();
    }
    var fhRecordStatu=false;
    //显示复核记录
    function showFhRecord(itemId){
        $("#fhrecordWrap").remove();
        $.ajax({
            url:'showFhRecord',
            data:{"itemId":itemId},
            success:function(data){
                var htm="<div id='fhrecordWrap'><table id='fhrecordTable'><thead><tr><td>参评人</td><td>评分项</td><td>自评分</td><td>复核分</td><td>复核人</td><td>复核时间</td><td>复核意见</td></tr></thead><tbody>";
                for(var i=0;i<data.records.length;i++){
                    if(i==0){
                        htm=htm+"<tr>" +
                            "<td rowspan='"+data.length+"'>"+data.owner+"</td>" +
                            "<td>"+data.records[i].name+"</td>" +
                            "<td>"+data.records[i].zp+"</td>" +
                            "<td>"+data.records[i].fh+"</td>" +
                            "<td>"+data.records[i].fhuser+"</td>" +
                            "<td>"+data.records[i].fhtime+"</td>" +
                            "<td >"+data.records[i].fhMessage+"</td>" +
                            "</tr>";
                    }else{
                        htm=htm+"<tr>" +
                            "<td>"+data.records[i].name+"</td>" +
                            "<td>"+data.records[i].zp+"</td>" +
                            "<td>"+data.records[i].fh+"</td>" +
                            "<td>"+data.records[i].fhuser+"</td>" +
                            "<td>"+data.records[i].fhtime+"</td>" +
                            "<td >"+data.records[i].fhMessage+"</td>" +
                            "</tr>";
                    }

                }
                htm=htm+"</tbody></table></div>";
                $(htm).appendTo("body");
                $("#fhrecordWrap").unbind("click").bind("click",function(){
                    $(this).remove();
                });
            }
        });


    }
</script>
</body>
</html>