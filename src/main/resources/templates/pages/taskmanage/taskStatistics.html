<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name=renderer  content=webkit>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <link th:href="@{/third/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/third/font-awesome-4.7.0/css/font-awesome.css}" rel="stylesheet">
    <link th:href="@{/third/css/animate.css}" rel="stylesheet">
    <link th:href="@{/third/DataTables/datatables.min.css}" rel="stylesheet">
    <link th:href="@{/third/lib/layui/css/layui.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/third/jtree/css/style.min.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/style.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/custom.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/awesome-bootstrap-checkbox.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/css/bootstrap_modify.css}" rel="stylesheet" type="text/css"></link>
    <title>任务统计</title>
    <style>
        #taskTable{
            text-align: center;

        }
        #taskTable thead{
            background: rgba(51,51,51,0.8);
            color: white;
        }
        #taskTable tbody{
            background: white;
            border-bottom: 1px dotted gray;
        }
        .userName_td{
            font-weight: bold;
            color: black;
        }
        body{
            background: #fffff5;
            overflow: scroll;
        }
        .byGroup{
            float: left;
            margin-left: 5px;
            clear: both;

        }
        #fhrecordWrap{
            position: absolute;
            left: 30%;
            top: 200px;
            height: 700px;
            overflow:scroll;
        }
        #fhrecordTable{
            background: rgba(51,51,51,0.8);
            color: white;
            width:100%;
            height: 100%;
            text-align: center;
            margin: 0px auto;
            cursor: pointer;

        }
        #fhrecordTable tr{
            border-bottom: 1px dotted gray;
        }
        #fhrecordTable tr td{
            padding:10px;
        }
        .fy{
            cursor: pointer;
            background: #5dbacf;
            padding: 3px;
            width: 50px;
            border-radius: 5px;
            color: white;
            margin-left: 3px;
        }
    </style>
</head>
<body>
<div class="wrapper wrapper-content animated fadeInRight" style="padding:0px;margin:0px;">
    <div class="row" style="padding:0px;margin:0px;">
        <div class="col-sm-12" style="padding:0px;margin:0px;">
                    <input type="hidden" th:value="${menuId}" id="menuId">
                    <input type="hidden" th:value="${taskId}" id="taskId">
                    <div  class="layui-card-header" style="border: none">
                         <div style="float: left;margin-left: 5px;">
                            <label style="color: black">任务名称:</label> <label th:text="${tasks.taskName}" style="color: #ff9090;"></label>
                        </div>
                        <div style="float: right;margin-right: 5px;">
                            <label>用户名：</label>
                            <input style="height:30px;margin-right: 8px" type="text" id="searchName" th:if="${searchName} eq 'all' ">
                            <input style="height:30px;margin-right: 8px" type="text" id="searchName" th:unless="${searchName} eq 'all' " th:value="${searchName}">
                            <button style="height:30px;" class="btn-sm btn-success" onclick="searchUser()">搜索</button>
                            &nbsp;
                            <button style="height:30px;" class="btn-sm btn-success" onclick="refreshPage()">刷新</button>
                            &nbsp;<label  style="color: red;font-weight: bold"><i class="fa fa-close"></i>:未提交</label>
                            &nbsp;<label style="color: royalblue;font-weight: bold"><i class="fa fa-check-square-o"></i>:已提交</label>
                            &nbsp;<label style="color: #56850e;font-weight: bold"><i class="fa fa-minus-square-o"></i>:部分提交</label>
                        </div>
                    </div>
                    <div class="hr-line-dashed" style="margin: 8px 0"></div>
                    <div  class="layui-card-header" style="border: none">
                        <div class="byGroup">
                            <label>分组查看：</label>
                            <select id="byGroup" style="height: 30px;">
                                <option th:each="g:${groups}" th:value="${g.id}" th:text="${g.name}" th:if="${g.id}==${groupId}" selected></option>
                                <option th:each="g:${groups}" th:value="${g.id}" th:text="${g.name}" th:unless="${g.id}==${groupId}" ></option>
                            </select>
                        </div>
                    </div>
                    <div class="hr-line-dashed" style="margin: 8px 0"></div>
                    <table id="taskTable"
                           class="table table-hover">
                        <thead>
                        <tr>
                            <td th:each="name:${tasks.names}" th:text="${name}" ></td>
                        </tr>
                        </thead>
                        <tbody>
                            <tr th:each="task:${tasks.its}">
                                <td th:text="${task.userName}" class="userName_td"></td>
                                <td th:each="item:${task.itmes}"  >
                                    <label  th:if="${item.statu}==0"  style="display:block;width:100%;color: red;font-weight: bold;cursor: pointer" onclick="readFile(this)">
                                        <label th:text="${item.totalFiles}" style="display:block;width:100%;cursor: pointer"></label><input type="hidden" th:value="${item.id}">
                                    </label>
                                    <label th:if="${item.statu}==1" style="display:block;width:100%;color: royalblue;font-weight: bold;cursor: pointer" onclick="readFile(this)">
                                        <label th:text="${item.totalFiles}" style="display:block;width:100%;cursor: pointer"></label><input type="hidden" th:value="${item.id}">
                                    </label>
                                    <label  th:if="${item.statu}==2" style="display:block;width:100%;color: #56850e;font-weight: bold;cursor: pointer" onclick="readFile(this)">
                                        <label th:text="${item.totalFiles}" style="display:block;width:100%;cursor: pointer"></label><input type="hidden" th:value="${item.id}">
                                    </label>
                                    <label  th:if="${item.statu}==-1" style="display:block;width:100%;color:red;font-weight: bold;cursor: pointer" onclick="readFile(this)">
                                        <label th:text="${item.itemValue}" style="display:block;width:100%;cursor: pointer"></label><input type="hidden" th:value="${item.id}"><input th:value="${item.type}" type="hidden">
                                    </label>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <input type="hidden" th:value="${tasks.page}" id="currentPage">
                    <input type="hidden" th:value="${tasks.totalPage}" id="totalPage">
                    <div style="text-align: center ">
                        <label>当前是:<label th:text="${tasks.page}" style="color: red"></label>页</label>
                        <label>共有:<label th:text="${tasks.totalPage}"  style="color: red"></label>页</label>
                        <label onclick="prePage()" style="cursor: pointer" class="fy">上一页</label> <label class="fy" onclick="nextPage()" style="cursor: pointer" id="nextPage">下一页</label>
                    </div>
        </div>
    </div>
</div>
<!-- 公共尾部开始 -->
<script th:src="@{/third/js/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.metisMenu.js}" type="text/javascript"></script>
<script th:src="@{/third/js/hAdmin.js}" type="text/javascript"></script>
<script th:src="@{/third/lib/layui/layui.all.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.validate.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/message_zh.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/validate_default.js}" type="text/javascript"></script>
<script th:src="@{/third/DataTables/datatables.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.slimscroll.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/global.js}" type="text/javascript"></script>
<script th:src="@{/third/js/sock.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.cookie.js}" type="text/javascript"></script>
<script th:src="@{/third/js/stomp.js}" type="text/javascript"></script>
<!-- 公共尾部结束 -->
<script>
    //预览文件
    function readFile($this){
        var itemId=$($this).find("input[type=hidden]").eq(0).val();
        var type=$($this).find("input[type=hidden]").eq(1).val();
        if(type==4){
            return ;
        }
        if(type==5){
            $("#fhrecordTable").remove();
            $.ajax({
                url:'showFhRecord',
                data:{"itemId":itemId},
                success:function(data){
                    var htm="<div id='fhrecordWrap'><table id='fhrecordTable'><thead><tr><td>参评人</td><td>评分项</td><td>自评分</td><td>复核分</td><td>复核人</td><td>复核时间</td></tr></thead><tbody>";
                    for(var i=0;i<data.records.length;i++){
                        if(i==0){
                            htm=htm+"<tr>" +
                                "<td rowspan='"+data.length+"'>"+data.owner+"</td>" +
                                "<td>"+data.records[i].name+"</td>" +
                                "<td>"+data.records[i].zp+"</td>" +
                                "<td>"+data.records[i].fh+"</td>" +
                                "<td>"+data.records[i].fhuser+"</td>" +
                                "<td>"+data.records[i].fhtime+"</td>" +
                                "</tr>";
                        }else{
                            htm=htm+"<tr>" +
                                "<td>"+data.records[i].name+"</td>" +
                                "<td>"+data.records[i].zp+"</td>" +
                                "<td>"+data.records[i].fh+"</td>" +
                                "<td>"+data.records[i].fhuser+"</td>" +
                                "<td>"+data.records[i].fhtime+"</td>" +
                                "</tr>";
                        }

                    }
                    htm=htm+"</tbody></table></div>";
                    $(htm).appendTo("body");
                    $("#fhrecordWrap").unbind("click").bind("click",function(){
                        $(this).remove();
                    });
                }
            });


            return ;
        }
        var showStatisticsDialog = layer.open({
                type : 2,
                title : "查看文件",
                content : "seeTaskFileDialog?itemId="+itemId,
                end : function() {

                }
            });
            layer.full(showStatisticsDialog);
    }
    //用户搜索
    function searchUser() {
        var taskId=$("#taskId").val();
       var searchName= $("#searchName").val();
        location.href="taskStatistics?taskId="+taskId+"&groupId="+$("#byGroup").val()+"&searchName="+searchName;
    }
    //刷新页面
    function refreshPage(){
        location.reload();
    }
    //组选择变更
    $("#byGroup").on("change",function () {
        var taskId=$("#taskId").val();
        $.ajax({
            url:'checkGroupMatchTask',
            data:{"groupId":$("#byGroup").val(),"taskId":taskId},
            success:function(data){
                if(data==1){
                    location.href="taskStatistics?taskId="+taskId+"&groupId="+$("#byGroup").val();
                }else{
                    layer.msg('该组没有成员参与本次任务', {
                        icon: 0,
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    }, function(){
                        location.href="taskStatistics?taskId="+taskId;
                    });


                }
            }
        })

    });
    //翻页
    function prePage(){
        var taskId=$("#taskId").val();
        var currentPage=$("#currentPage").val();
        var searchName=$("#searchName").val();
        if(searchName==""){
            searchName="all";
        }
        if(currentPage-1<=0){
            layer.msg("已经是第一页！")
            return ;
        }else{
            currentPage= parseInt(currentPage)-1;
            location.href="taskStatistics?taskId="+taskId+"&groupId="+$("#byGroup").val()+"&page="+currentPage+"&searchName="+searchName;
        }
    }
    function nextPage() {
        var taskId=$("#taskId").val();
        var currentPage=$("#currentPage").val();
        var totalPage=$("#totalPage").val();
        var searchName=$("#searchName").val();
        if(searchName==""){
            searchName="all";
        }
        if(currentPage+1>totalPage){
            layer.msg("已经是最后一页！")
            return ;
        }else{
            currentPage= parseInt(currentPage)+1;
            location.href="taskStatistics?taskId="+taskId+"&groupId="+$("#byGroup").val()+"&page="+currentPage+"&searchName="+searchName;
        }
    }
</script>
</body>
</html>