<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name=renderer  content=webkit>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <link th:href="@{/third/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/third/font-awesome-4.7.0/css/font-awesome.css}" rel="stylesheet">
    <link th:href="@{/third/css/animate.css}" rel="stylesheet">
    <link th:href="@{/third/DataTables/datatables.min.css}" rel="stylesheet">
    <link th:href="@{/third/lib/layui/css/layui.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/third/jtree/css/style.min.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/custom.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/awesome-bootstrap-checkbox.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/css/bootstrap_modify.css}" rel="stylesheet" type="text/css"></link>
    <title>新增群组</title>
    <style type="text/css">
        .users{
            float: left;
            text-align: left;
            background: rgb(111 151 147);
            height: 600px;
            width: 190px;
            overflow: scroll;
        }
        .users li{
            padding: 12px;
            color:white;
            border-bottom: 1px solid #b5b5a9;

        }
        .users li label{
            cursor:pointer;
        }
        .users li:first-child{
            padding: 0px;
        }
        .users li:first-child input{
            height: 30px;
            color:black;
            border:none;
            width: 100%;
        }
        .members{
            float: left;
            height: 600px;
            width: 590px;
            overflow: scroll;
        }
        .members li{
            background: #dae3da;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            color: #536864;
            text-align: center;
            float:left;
            width: 120px;
            overflow: auto;
            cursor: pointer;
        }
        .hasadd{
            margin: 5px;
            text-align: center;
            float: left;
            width: 590px;
            position: relative;
            border-bottom: 1px solid #e1d9d9;
        }
        .hasadd_label{
            background: #dae3da;
            border-radius: 5px;
            color: #536864;
            padding: 10px;
            margin: 5px;
        }
        .hasadd_btn{
            margin: 5px;
            position: absolute;
            right: 15px;
            top:8px;
        }
        body{
            background: white;
            overflow: hidden;
        }
        .isAdmin{
            color:orangered;
        }
        .notAdmin{
            color: gray;
        }
    </style>
</head>
<body>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row" style="margin: 0px">
        <div class="col-sm-12" style="margin: 0px;padding:0px;background: #f3f3f3">
            <div class="ibox float-e-margins">
                <div class="ibox-content">
                    <input type="hidden" id="groupId" th:value="${groupId}">
                    <ul class="users" id="users">
                        <li><input type="text" placeholder="搜索群组成员"></li>
                        <li th:each="user:${users}">
                            <i class="fa fa-user-circle" style="font-size: 16px"></i>
                            <label style="font-size: 18px" class="list_user">
                                <span  th:text="${user.getUsername()}"></span>
                                <input type="hidden" th:if="${user.isMember()}" value="1">
                                <input type="hidden" th:unless="${user.isMember()}" value="0">
                                <input type="hidden" th:value="${user.id}">
                                <i class="checkbox_icon fa fa-check" th:if="${user.isMember()}"></i>
                                <i class="checkbox_icon fa fa-check" th:unless="${user.isMember()}" style="display: none"></i>
                            </label>
                        </li>
                    </ul>
                    <div class="hasadd"><label class="hasadd_label">已添加群组成员</label><button class="btn btn-success hasadd_btn" id="saveGroup">保存</button></div>
                    <ul class="members" id="members">
                        <li th:each="user:${groupUsers}">
                            <input type="hidden" th:value="${user.id}">
                            <label th:text="${user.getUsername()}" style="font-size: 16px"></label>
                            <br/>
                            <i class="fa fa-user-secret isAdmin" th:if="${user.isAdmin()}"></i>
                            <i class="fa fa-user-secret notAdmin" th:unless="${user.isAdmin()}"></i>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 公共尾部开始 -->
<!-- 公共尾部开始 -->
<script th:src="@{/third/js/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.metisMenu.js}" type="text/javascript"></script>
<script th:src="@{/third/js/hAdmin.js}" type="text/javascript"></script>
<script th:src="@{/third/lib/layui/layui.all.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.validate.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/message_zh.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/validate_default.js}" type="text/javascript"></script>
<script th:src="@{/third/DataTables/datatables.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.slimscroll.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/global.js}" type="text/javascript"></script>
<script th:src="@{/third/js/sock.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.cookie.js}" type="text/javascript"></script>
<script th:src="@{/third/js/stomp.js}" type="text/javascript"></script>
<script th:src="@{/third/jtree/js/jstree.min.js}" type="text/javascript"></script>
<!-- 公共尾部结束 -->
<script>
    var admins=new Array();//已经指定的管理员
    var users=new Array();//已经添加的群组成员
    $(document).ready(function(){
        var result=$("#addGroupForm").validate({
            rules: {
                name:{
                    required:true,
                    stringCheck:true,
                    maxlength:20,
                    minlength:2
                }
            }
        });
        $("#addGroupForm").on("submit",function(event){
            if(result.form()){
                saveGroup();
            }else{
                layer.msg("表单中有错误！");
            }
            return false;
        });
    });
    function saveGroup(){
        var name=$("#name").val();
        var isUse=$("#isUse").val();
        var params={"name":name,"isUse":isUse,"admins":admins,"users":users};
        $.ajax({
            url:'addGroup',
            type:'post',
            data:params,
            traditional:true,
            success:function(data){
                if(data==-1){
                    layer.msg("该群组已存在");
                    return ;
                }
                layer.msg("新增成功",{
                        icon:1,
                        time:2000
                    },
                    function(){
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                    });
            }
        }) ;
    }
    //群组成员改变
    $(".list_user").unbind("click").bind("click",function () {
       var checked= $(this).find("input[type='hidden']").eq(0).val();
       var username=$(this).find("span").eq(0).text();
       if(checked=="1"){
           $(this).find("input[type='hidden']").eq(0).val("0");
           $(this).find("i").hide();

           $(".members li").each(function(){
              var u=$(this).find("label").text();
              if(username==u){
                  $(this).remove();
              }
           });

       }else{
           $(this).find("input[type='hidden']").eq(0).val("1");
           $(this).find("i").show();
           var u_id=$(this).find("input[type='hidden']").eq(1).val();
           var htm="<li><input type='hidden' value='"+u_id+"'><label style='font-size: 16px'>"+username+"</label>" +
               "<br/><i class='fa fa-user-secret notAdmin'></i></li>";
           $(htm).appendTo($(".members"));
           $(".members li").unbind("click").bind("click",function () {
               var changeAdmin=$(this).find("i").hasClass("isAdmin");
               if(changeAdmin){
                   $(this).find("i").removeClass("isAdmin").addClass("notAdmin");
               }else{
                   $(this).find("i").removeClass("notAdmin").addClass("isAdmin");
               }
           });
       }
    });
    //设置管理员
    $(".members li").unbind("click").bind("click",function () {
        var changeAdmin=$(this).find("i").hasClass("isAdmin");
        if(changeAdmin){
            $(this).find("i").removeClass("isAdmin").addClass("notAdmin");
        }else{
            $(this).find("i").removeClass("notAdmin").addClass("isAdmin");
        }
    });
    //提交
    $("#saveGroup").unbind("click").bind("click",function () {
        var members=new Array();
        var admins=new Array();
        $(".members li").each(function(){
           var m_id= $(this).find("input[type='hidden']").val();
            var isAdmin= $(this).find("i").hasClass("isAdmin");
            if(isAdmin){
                admins.push(m_id);
            }
            members.push(m_id);
        });
        if(members.length<=0){
            layer.msg("请至少添加一位群组成员!");
            return ;
        }
        if(admins.length<=0){
            layer.msg("请至少指定一位群组管理员!");
            return ;
        }
        $.cookie("members",members);
        $.cookie("admins",admins);
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    });
</script>
</body>
</html>