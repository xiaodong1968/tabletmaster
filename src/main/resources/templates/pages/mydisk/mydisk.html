<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name=renderer  content=webkit>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <link th:href="@{/third/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/third/font-awesome-4.7.0/css/font-awesome.css}" rel="stylesheet">
    <link th:href="@{/third/css/animate.css}" rel="stylesheet">
    <link th:href="@{/third/DataTables/datatables.min.css}" rel="stylesheet">
    <link th:href="@{/third/lib/layui/css/layui.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/third/jtree/css/style.min.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/style.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/custom.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/jtree/css/awesome-bootstrap-checkbox.css}" rel="stylesheet" type="text/css"></link>
    <link th:href="@{/third/css/bootstrap_modify.css}" rel="stylesheet" type="text/css"></link>
    <title>角色管理</title>
    <style>
        .dir_nav{
            text-align: left;
            padding: 5px;
            background: #d5e1da;
            color: #363333;
            height: 35px;
            line-height: 25px;
        }
        .dir_nav_label{
            cursor: pointer;
            font-size: 16px;
        }
        .dirs{
            font-size: 14px;
        }
        #copyTemp{
            position: absolute;
            left: 45%;
            top:55%;
            width: 70px;
            height: 70px;
            background: rgba(51,51,51,0.8);
            text-align: center;
            z-index: 9999999999999;
            color: white;
            border-radius: 70px;
            line-height: 70px;
            font-size: 16px;
        }
        #copyTemp  label{
            cursor: pointer;
        }
        .mvchoice{
            background: #cbedb6;
            border: 1px dotted #ebe4e4;
        }
    </style>
</head>
<body>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>
                        我的网盘
                    </h5>
                    <div class="ibox-tools">
                        <a class="dropdown-toggle" onClick="javascript:location.reload();"> <i class="fa fa-refresh"></i></a>
                    </div>
                </div>
                <div class="ibox-content">
                    <input type="hidden" th:value="${menuId}" id="menuId">
                    <div id="copyTemp" style="display: none">
                        <label onclick="parseDir(this)">粘贴</label>
                        <br/>
                        <i class="fa fa-window-close" style="color: red" onclick="closeCopyTemp()"></i>
                        <input type="hidden" id="copyTemp_id">
                    </div>
                    <form  class="form-inline" id="searchForm">
                        <div class="form-group">
                            <label  class="form-label">用户名：</label>
                            <input type="text" placeholder="请输入用户名" class="form-control" id="key_name">
                        </div>
                        <div class="form-group">
                            <label  class="form-label">用户状态：</label>
                            <select class="form-control" id="key_isUse" style="width:196px;">
                                <option value="-1">全部</option>
                                <option value="1">启用</option>
                                <option value="2">禁用</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <a class="btn btn-success" onClick="searchUser()"  style="background: rgb(0,150,136)">搜索</a>
                        </div>
                    </form>
                    <div class="hr-line-dashed" style="margin: 8px 0"></div>
                    <div  class="layui-card-header" style="border: none">
                        <a th:id='${btn.func}' th:each="btn:${menuButton}" class="layui-btn">
                            <i th:class="${btn.icon}"></i>
                            <span th:text="${btn.name}"></span>
                        </a>
                    </div>
                    <div class="hr-line-dashed" style="margin: 8px 0"></div>
                    <div id="myContent" style="overflow: auto;height: 650px;">
                        <div class="dir_nav">
                            <input id="rootDir" type="hidden" th:value="${mydir.id}">
                            <input id="currentDir" type="hidden" th:value="${mydir.id}">
                            <input id="currentParentDir" type="hidden" th:value="${mydir.parentId}">
                            <label  class="dir_nav_label" th:onclick="openDir(-1)"><i class="fa fa-arrow-left "></i></label>
                            &nbsp;
<!--                            <label  class="dir_nav_label"  th:onclick="openDir(-2)"><i class="fa fa-arrow-right"></i></label>-->
<!--                            &nbsp;-->
                            <i class="fa fa-desktop"></i>
                            <label class="dirs"><a th:onclick="openDir([[${mydir.id}]])">我的网盘 </a></label>
                        </div>
                    <!--我的网盘-->
                        <!--个人空间如果尚未被初始化-->
                        <div th:unless="(${mydir.child_file_total}+${mydir.child_total})>0" id="nullspace" style="text-align: center;margin: 60px">
                            <i class="layui-icon layui-icon-404" style="font-size:300px"></i>
                            <br/>
                            <label style="color: #d76a6a;font-size: 16px">你还未上传任何文件哦！开始上传第一个文件吧。</label>
                        </div>
                        <!--个人空间如果已经被初始化-->
                        <div id="dirspace">
                            <div class='myfolderWrap' th:each="dir:${dm.dirs}">
                                <input type="hidden" th:value="${dir.id}">
                                <i class="fa  fa-folder myfolder"  th:if="${dir.shareToGroup}">
                                    <i class="fa fa-share-alt shareicon" ></i>
                                </i>
                                <i class="fa fa-folder myfolder" th:unless="${dir.shareToGroup}"></i>
                                <br/><label th:text="${dir.name}"></label>
                                <div class="childMenu" style="display:none">
                                    <ul>
                                        <li th:onclick="openDir([[${dir.id}]])">打开</li>
                                        <li th:onclick="resetDirName([[${dir.id}]],this)">重命名</li>
                                        <li th:onclick="moveDir([[${dir.id}]],this)">剪切</li>
                                        <li th:onclick="delDir([[${dir.id}]],this)">删除</li>
                                        <li th:onclick="shareDir([[${dir.id}]],this)">共享</li>
                                    </ul>
                                </div>
                            </div>
                            <div class='myfolderWrap' th:each="file:${dm.files}">
                                <input type="hidden" th:value="${file.id}">
                                <input type="hidden" th:value="${file.type}">
                                <label th:if="${file.type}==2" style="font-size: 70px;color:#d76b6b;cursor:pointer"><i class="fa fa-file-pdf-o"></i></label>
                                <br/>
                                <label th:text="${file.name}"></label>
                                <div class="childMenu" style="display:none">
                                    <ul>
                                        <li th:onclick="read([[${file.id}]],[[${file.type}]])">打开</li>
                                        <li th:onclick="resetDirName([[${dir.id}]],this)">重命名</li>
                                        <li th:onclick="moveDir([[${dir.id}]],this)">剪切</li>
                                        <li th:onclick="delDir([[${dir.id}]],this)">删除</li>
                                        <li th:onclick="shareDir([[${dir.id}]],this)">共享</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!---->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 公共尾部开始 -->
<script th:src="@{/third/js/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.metisMenu.js}" type="text/javascript"></script>
<script th:src="@{/third/js/hAdmin.js}" type="text/javascript"></script>
<script th:src="@{/third/lib/layui/layui.all.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.validate.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/message_zh.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/validate_default.js}" type="text/javascript"></script>
<script th:src="@{/third/DataTables/datatables.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.slimscroll.min.js}" type="text/javascript"></script>
<script th:src="@{/third/js/global.js}" type="text/javascript"></script>
<script th:src="@{/third/js/sock.js}" type="text/javascript"></script>
<script th:src="@{/third/js/jquery.cookie.js}" type="text/javascript"></script>
<script th:src="@{/third/js/stomp.js}" type="text/javascript"></script>
<!-- 公共尾部结束 -->
<script>
    var menuId=$("#menuId").val();
    $("#searchForm").on("submit",function(){
        return false;
    });
    //新增文件夹
    $("#addDir").unbind("click").bind("click",function () {
        layer.prompt({title: '请输入文件夹名', formType: 3}, function(name, index){
            if(name==null||name==""){
                layer.msg("名称不能为空!");
                return ;
            }
            if(name.length>20){
                layer.msg("名称太长!");
                return ;
            }
            if(!(/^[\u4E00-\u9FA5a-zA-Z0-9_]*$/.test(name))){
                layer.msg("不能有非法字符!");
                return ;

            }
            if(checkDirName(name)){
                layer.msg("名称重复！");
                return ;
            }
           $.ajax({
               url:"addDir",
               type:'post',
               data:{"name":name,"parentId":$("#currentDir").val()},
               success:function(data){
                   if(data==null){
                       layer.msg("新增失败！");
                   }
                  else{
                       layer.close(index);
                       renderHtml(data);
                   }
               }
           })
        });
    });
    //渲染文件
    function renderFileHtml(data){
        $("#nullspace").hide();
        var htm;
        htm="<div class='myfolderWrap'><input type='hidden' value='"+data.id+"'><input type='hidden' value='"+data.type+"'>";
        if(data.type==2){
            htm=htm+"<label style='font-size: 70px;color:#d76b6b;cursor:pointer'><i class='fa fa-file-pdf-o'></i></label><br/>";
        }
        htm=htm+"<label>"+data.name+"</label>";
        $(htm).appendTo($("#dirspace"));
        $(".myfolderWrap").hover(function(){
            if($(this).find("div[class='childMenu']").length!=0){
                $(this).find("div[class='childMenu']").show();
                return ;
            }
            var htm2="<div class='childMenu'><ul>" +
                "<li onclick='readFile("+data.id+","+data.type+")'>打开</li>" +
                "<li onclick='resetDirName("+data.id+",this)'>重命名</li>" +
                "<li onclick='moveDir("+data.id+",this)'>剪切</li>" +
                "<li onclick='delDir("+data.id+",this)'>删除</li>" +
                "<li onclick='shareDir("+data.id+",this)'>共享</li><" +
                "/ul></div>";
            $(htm2).appendTo($(this));
        },function () {
            $(this).find("div[class='childMenu']").hide();
        });
    }
    //渲染文件夹
    function renderHtml(data){
        $("#nullspace").hide();
        var htm;
        if(data.id==$("#copyTemp_id").val()){
            htm="<div class='myfolderWrap mvchoice'><input type='hidden' value='"+data.id+"'>";
            if(data.shareToGroup){
            htm=htm+"<i class='fa fa-folder myfolder'><i class='fa fa-share-alt shareicon' ></i></i>";
            }else{
                htm=htm+"<i class='fa fa-folder myfolder'></i>";
            }
            htm=htm+"<br/><label>"+data.name+"</label></div>";
        }
        else{
            htm="<div class='myfolderWrap'><input type='hidden' value='"+data.id+"'>";
            if(data.shareToGroup){
                htm=htm+"<i class='fa fa-folder myfolder'><i class='fa fa-share-alt shareicon' ></i></i>";
            }else{
                htm=htm+"<i class='fa fa-folder myfolder'></i>";
            }
            htm=htm+"<br/><label>"+data.name+"</label></div>";
        }
        $(htm).appendTo($("#dirspace"));
        $(".myfolderWrap").hover(function(){
            if($(this).find("div[class='childMenu']").length!=0){
                $(this).find("div[class='childMenu']").show();
                return ;
            }
            var htm2="<div class='childMenu'><ul>" +
                "<li onclick='openDir("+data.id+")'>打开</li>" +
                "<li onclick='resetDirName("+data.id+",this)'>重命名</li>" +
                "<li onclick='moveDir("+data.id+",this)'>剪切</li>" +
                "<li onclick='delDir("+data.id+",this)'>删除</li>" +
                "<li onclick='shareDir("+data.id+",this)'>共享</li><" +
                "/ul></div>";
            $(htm2).appendTo($(this));
        },function () {
            $(this).find("div[class='childMenu']").hide();
        });
    }
    $(".myfolderWrap").hover(function(){
        if($(this).find("div[class='childMenu']").length!=0){
            $(this).find("div[class='childMenu']").show();
        }
    },function () {
        $(this).find("div[class='childMenu']").hide();
    });
    //打开目录
    function openDir(id,navclick){
            if($("#copyTemp_id").val()==id){
                layer.msg("不可以哦！");
                return ;
            }
            var model=0;
            var rootId=$("#rootDir").val();
            if(id==rootId){
                model=2;//如果是直接点击用户根目录
            }
            if(navclick!=null){
                model=3;//如果是直接点击导航中的目录
            }
            if(navclick!=null&&navclick=="refresh"){
                model=4;//如果是刷新当前目录
            }
            if(id==-1){
                id= $("#currentParentDir").val();
                if(id==rootId){//如果向上翻的是根目录
                    model=2;
                }
                else{
                    model=1;//如果是向上翻目录
                }
            }
            if(id==-2){
                id= $("#currentDir").val();

            }
            if(id==0){//如果已经是根目录
               return ;
            }
            $.ajax({
                url:'openDir',
                data:{"parentId":id},
                success:function(data){
                    $("#currentDir").val(id);
                    $("#currentParentDir").val(data.parentId);
                    if(model==1){
                       var index= $(".dirs").html().lastIndexOf("》")-8;
                       var restr= $(".dirs").html().substring(0,index);
                        $(".dirs").html(restr);
                    }
                    if(model==2){
                        var index= $(".dirs").html().indexOf("》");
                        if(index==-1){
                            return ;
                        }
                        var restr= $(".dirs").html().substring(0,index);
                        $(".dirs").html(restr);
                    }
                    if(model==3){
                        $(navclick).parent().nextAll().remove();
                    }
                    if(model==0){
                        var htm="<label> 》<a onclick='openDir("+id+",this)'>"+data.currentName+"</a></label>";
                        $(htm).appendTo($(".dirs"));
                    }
                    $("#dirspace").children().remove();
                    for(var i=0;i<data.dirs.length;i++){
                         renderHtml(data.dirs[i]);
                    }
                    for(var i=0;i<data.files.length;i++){
                        renderFileHtml(data.files[i]);
                    }
                }
            })
    }
    //检查是否存在同名目录
    function checkDirName(name){
        var hasSame=false;
        $(".myfolderWrap").each(function(){
            var exist=$(this).find("label").eq(0).html();
            if(name==exist){
                hasSame=true;
               return hasSame;
            }
        });
        return hasSame;
    }
    //目录重命名
    function resetDirName(dirId,$this){
        var orgname=$($this).parent().parent().parent().find("label").html();
        layer.prompt({title: '请输入新的名称', formType: 3}, function(name, index){
            if(name==null||name==""){
                layer.msg("名称不能为空!");
                return ;
            }
            if(name.length>20){
                layer.msg("名称太长!");
                return ;
            }
            if(!(/^[\u4E00-\u9FA5a-zA-Z0-9_]*$/.test(name))){
                layer.msg("不能有非法字符!");
                return ;

            }
            if(orgname==name){
                layer.msg("不能和原来的名称一样");
                return ;
            }
            if(checkDirName(name)){
                layer.msg("名称重复！");
                return ;
            }
            $.ajax({
                url:"restDirName",
                type:'post',
                data:{"dirId":dirId,"name":name},
                success:function(data){
                    if(data==null){
                        layer.msg("修改失败！");
                    }
                    else{
                        layer.close(index);
                        $(".myfolderWrap").each(function(){
                           var id=$(this).find("input[type='hidden']").val();
                           if(id==dirId){
                               $(this).find("label").eq(0).html(name);
                           }
                        });
                    }
                }
            })
        });
    }
    //移动目录
    function moveDir(dirId,$this){
        $("#copyTemp").show();
        $("#copyTemp_id").val(dirId);
        $($this).parent().parent().parent().addClass("mvchoice");

    }
    //粘贴目录
    function parseDir($this){
       var dirId= $("#copyTemp_id").val();
       var currentDirId=$("#currentDir").val();
       $.ajax({
           url:"parseDir",
           type:'post',
           data:{"dirId":dirId,"parentId":currentDirId},
           success:function(data){
               if(data==0){
                   layer.msg("剪切失败！")
                   closeCopyTemp();
                   return ;
               }
               if(data==1){
                   closeCopyTemp();
                   openDir(currentDirId,"refresh");
               }
           }
       })
    }
    //隐藏粘贴板
    function closeCopyTemp(){
        $(".mvchoice").each(function(){
            $(this).removeClass("mvchoice");
        })
        $("#copyTemp_id").val("");
        $("#copyTemp").hide();
    }
    //删除目录
    function delDir(dirId,$this){
        var index=layer.confirm("确认要删除该目录吗？", {icon: 1, title:'确认'}, function(index){
            $.ajax({
                url:"delDir",
                type:'post',
                data:{"dirId":dirId},
                success:function (data) {
                    if(data==0){
                        layer.msg("删除失败！");
                    }
                    if(data==1){
                        var  currentDir= $("#currentDir").val();
                        closeCopyTemp();
                        openDir(currentDir,"refresh");
                    }
                    layer.close(index);
                }
            })
        });
    }
    //共享目录到群组
    function shareDir(dirId,$this){
        var shareDir = layer.open({
            type : 2,
            title : "群组共享",
            area:["800px","600px"],
            content : "shareDirDialog?dirId="+dirId,
            end:function () {
                closeCopyTemp();
                var  currentDir= $("#currentDir").val();
                openDir(currentDir,"refresh");
            }
        });
    }
    //读取文件
    function readFile(fileId,fileType){
        if(fileType==2){
            var addGroup = layer.open({
                type : 2,
                title : "文件预览",
                content : "readFile/"+fileId,
                end : function() {

                }
            });
            layer.full(addGroup);
        }else{
            layer.msg("该类型文件暂不支持预览，请下载");
        }

    }
</script>
</body>
</html>